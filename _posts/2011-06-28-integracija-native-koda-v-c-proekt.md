---
title: |
    Интеграция Native кода в C# проект
date: 2011-06-28
authors: [FiloXSee]
tags: [c++, c#, программирование, настройка проекта, отладка]
categories: [C#]
permalink: /blog/c_sharp/499.html
blogcat: C#
excerpt_separator: <!--cut-->
---

Сегодня стала очень популярной платформа .Net Framework и язык C#. На ней пишутся приложения, игры, инструменты. Однако существует много кода написанного на C++, который часто нужно использовать в C# проектах.

Это могут быть математические библиотеки, код оставшийся от прошлых проектов или другой проект, написанный на C++ для которого нужно сделать графический интерфейс.

В этой статье речь пойдет о том, как интегрировать Native код в C# проект и успешно его развивать. В качестве IDE будет использоваться Microsoft Visual Studio.

<!--cut-->


#### Настройка проектов


На прямую вызывать C++ код из C# нельзя. Так же нельзя подключить к C# проекту native проект. Поэтому нам понадобится дополнительная прослойка - Managed C++ проект. Этот проект создаст Managed dll, которая будет затем подключена в основное приложение. Смысл этого проекта в том, что он может содержать как managed код так unmanaged код, т.е. код на обычном C++. Более того, он может подключать обычный native проект и использовать его код.

Рассмотрим интеграцию C++ проекта в C# проект на простом примере. Создадим солюшен с Windows Forms проектом. Это будет наше приложение. Нам нужно подключить к нему native проект.

Для начала подключим его к салюшену и укажем чтобы он собирался как _Static library_. Это можно указать в настройках проекта.


![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/9f539f.jpg)


Как уже было сказано, мы не можем напрямую использовать этот код в нашем приложении. Поэтому создадим дополнительный проект, который будет связующим звеном. Создаем его обычными средствами, как простой C++ проект.


![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/be38a3.jpg)


При создании проекта указываем, чтобы его код компилировался в dll. Кроме того указываем, чтобы это был пустой проект.

![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/4af727.jpg)


После создания проекта нужно указать что это managed проект. Для этого в его настройках нужно выбрать параметр _/crt_. Именно этот флаг скажет компилятору, что нужно сделать managed сборку.

![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/2e58d5.jpg)


В этот проект можно подключать другие managed сборки. Их нужно указать в разделе _Reference_. В разделе _Project Dependencies..._ выберите native проект, который мы подключили раньше.

![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/4d64d3.jpg)


![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/2df92d.jpg)


Ну и не забудьте подключить Managed C++ проект к C# проекту через _Reference_. Настройка проекта завершена. Теперь вы можете написать код на Managed C++, который будет использовать С++ код напрямую. Это будет обертка управляемого кода, которую можно будет использовать в C#.

#### Использование native кода в Managed C++


Класс написанный на Managed C++ может напрямую использовать С++ код. Экземпляр управляемого класса может содержать указатель на не управляемый класс.


```cpp
// C++
public class Foo
{
public:
  void  Do();
}

// Managed C++
public ref FooWrapper
{
public:
      FooWrapper()
      {
           m_class = new Foo();
      }
      void Shutdown()
      {
           delete( m_class );
      }

      void Do()
      {
           m_class->Do();
      }
private:
      Foo*     m_class;
}
```

```csharp
// C#
FooWrapper foo = new FooWrapper();
foo.Do();
foo.Shutdown();
```


Не забывайте следить за освобождением выделенной памяти. В неуправляемом коде управление памятью ложится на программиста.

**Совет:** Не стоит делать обертки для всех native классов. Значительно лучше выносить только высоко-уровневые функции, чтобы инкапсулировать всю функциональность в native коде.

Например если это библиотека, которая проводит какие то расчеты и выдает результат, то все это можно оформить в статическую функцию класса.


```cpp
// Managed C++
public ref FooWrapper
{
public:
      static void Do()
      {
           m_class = new Foo();
           m_class->Do();
           delete( m_class );
      }
}
```

```csharp
// C#
FooWrapper.Do();
```


#### Отладка


Одной из проблем при разработке приложений является их отладка. По умолчанию нет возможности при отладке спускаться по стеку в native код. Однако можно включить в настройках проекта опцию _Enable unmanaged code debugging_ и при отладке можно будет остановить приложение с просматривать callstack от native кода.


![](http://itw66.ru/uploads/images/00/00/02/2011/06/28/158649.jpg)


Однако это приведет к некоторому снижению производительности, поэтому имеет смысл создать дополнительную build-конфигурацию и собирать ее в тот момент когда нужно дебажить native код.
