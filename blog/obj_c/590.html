<!doctype html><html lang="ru-RU" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Выполнение блока кода в определенном потоке" /><meta name="author" content="MrDekk" /><meta property="og:locale" content="ru_RU" /><meta name="description" content="Когды Вы начинаете работать с блоками, то сразу возникает вопрос: “Есть блок кода, могу ли я просто выполнить его на определенном потоке?”. Слава богу - ответ “Да”, но Apple почему-то не дала простого способа сделать этого, что на Mac OS X, что на iOS. Однако ситуацию можно легко исправить. Как? Прошу под кат…" /><meta property="og:description" content="Когды Вы начинаете работать с блоками, то сразу возникает вопрос: “Есть блок кода, могу ли я просто выполнить его на определенном потоке?”. Слава богу - ответ “Да”, но Apple почему-то не дала простого способа сделать этого, что на Mac OS X, что на iOS. Однако ситуацию можно легко исправить. Как? Прошу под кат…" /><link rel="canonical" href="http://itw66.ru/blog/obj_c/590.html" /><meta property="og:url" content="http://itw66.ru/blog/obj_c/590.html" /><meta property="og:site_name" content="It Works!" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2012-02-05T00:00:00+06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Выполнение блока кода в определенном потоке" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MrDekk","url":"http://mrdekk.ru"},"dateModified":"2023-07-09T22:01:02+05:00","datePublished":"2012-02-05T00:00:00+06:00","description":"Когды Вы начинаете работать с блоками, то сразу возникает вопрос: “Есть блок кода, могу ли я просто выполнить его на определенном потоке?”. Слава богу - ответ “Да”, но Apple почему-то не дала простого способа сделать этого, что на Mac OS X, что на iOS. Однако ситуацию можно легко исправить. Как? Прошу под кат…","headline":"Выполнение блока кода в определенном потоке","mainEntityOfPage":{"@type":"WebPage","@id":"http://itw66.ru/blog/obj_c/590.html"},"url":"http://itw66.ru/blog/obj_c/590.html"}</script><title>Выполнение блока кода в определенном потоке | It Works!</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="It Works!"><meta name="application-name" content="It Works!"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/logo.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">It Works!</a></div><div class="site-subtitle fst-italic">Научно-популярный портал о технологиях настоящего и будущего!</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>ДОМАШНЯЯ СТРАНИЦА</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>КАТЕГОРИИ</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>ТЕГИ</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>АРХИВ</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>О САЙТЕ</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mrdekk/itw66.ru" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Домашняя страница </a> </span> <span>Выполнение блока кода в определенном потоке </span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Публикация</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Поиск..." > </span> <span id="search-cancel">Отменить</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Выполнение блока кода в определенном потоке</h1><div class="post-meta text-muted"> <span> Время публикации <em class="" data-ts="1328378400" data-df="DD/MM/YYYY" data-bs-toggle="tooltip" data-bs-placement="bottom" > 05/02/2012 </em> </span> <span> Обновлено <em class="" data-ts="1688922062" data-df="DD/MM/YYYY" data-bs-toggle="tooltip" data-bs-placement="bottom" > 09/07/2023 </em> </span><div class="d-flex justify-content-between"> <span> Автор <em> <a href="http://mrdekk.ru">MrDekk</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="811 слов" > <em>4 минут</em> чтения</span></div></div></div><div class="post-content"><p>Когды Вы начинаете работать с блоками, то сразу возникает вопрос: “Есть блок кода, могу ли я просто выполнить его на определенном потоке?”. Слава богу - ответ “Да”, но Apple почему-то не дала простого способа сделать этого, что на Mac OS X, что на iOS. Однако ситуацию можно легко исправить. Как? Прошу под кат…</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">@implementation</span> <span class="nc">NSThread</span><span class="p">(</span><span class="nl">BlockOnThread</span><span class="p">)</span>
 
<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_performBlockOnMainThread</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span>
<span class="p">{</span>
    <span class="p">[[</span><span class="n">NSThread</span> <span class="nf">mainThread</span><span class="p">]</span> <span class="nf">BOT_performBlock</span><span class="p">:</span> <span class="n">block</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_performBlockInBackground</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">NSThread</span> <span class="nf">performSelectorInBackground</span><span class="p">:</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">BOT_runBlock</span><span class="p">:)</span>
                               <span class="nl">withObject:</span> <span class="p">[[</span><span class="n">block</span> <span class="nf">copy</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">]];</span>
<span class="p">}</span>
 
<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_runBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span>
<span class="p">{</span>
    <span class="n">block</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_performBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([[</span><span class="n">NSThread</span> <span class="nf">currentThread</span><span class="p">]</span> <span class="nf">isEqual</span><span class="p">:</span> <span class="n">self</span><span class="p">])</span>
        <span class="n">block</span><span class="p">(</span> <span class="p">);</span>
    <span class="k">else</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">BOT_performBlock</span><span class="p">:</span> <span class="n">block</span> <span class="nf">waitUntilDone</span><span class="p">:</span> <span class="nb">NO</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_performBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span> <span class="nf">waitUntilDone</span><span class="p">:</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">wait</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">NSThread</span> <span class="nf">performSelector</span><span class="p">:</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">BOT_runBlock</span><span class="p">:)</span>
                     <span class="nl">onThread:</span> <span class="n">self</span>
                   <span class="nl">withObject:</span> <span class="p">[[</span><span class="n">block</span> <span class="nf">copy</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">]</span>
                <span class="nl">waitUntilDone:</span> <span class="n">wait</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">BOT_performBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)())</span><span class="nv">block</span> <span class="nf">afterDelay</span><span class="p">:</span> <span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">delay</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">performSelector</span><span class="p">:</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">BOT_performBlock</span><span class="p">:)</span> 
               <span class="nl">withObject:</span> <span class="p">[[</span><span class="n">block</span> <span class="nf">copy</span><span class="p">]</span> <span class="nf">autorelease</span><span class="p">]</span> 
               <span class="nl">afterDelay:</span> <span class="n">delay</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">@end</span>
</pre></table></code></div></div><p>Эта категория просто добавляет несколько методов к интерфейсу класса NSThread, которые позволят вам выполнить любой блок кода на любом потоке, к которому вы имеете доступ. Увы, к названиям методов пришлось добавить префиксы, так как Objective-C не поддерживает пространства имен (а-ля, namespace в C++).</p><p>Для более глубокого понимания того, как работают блоки кода, можете обратится к документации Apple <a href="http://developer.apple.com/library/ios/#documentation/cocoa/Conceptual/Blocks/Articles/00_Introduction.html">“Apple Blocks Programming Topics”</a>.</p><p>Кроме блоков, в Mac OS 10.6 Apple ввела также технологию <a href="http://developer.apple.com/technologies/mac/snowleopard/gcd.html">Grand Central Dispatch</a> (GCD). Предполагается, что в том случае, если необходимо выполнить ресурсоемкие вычисления на главном потоке, то необходимо использовать технологию GCD. Однако, существуют ситуации (например, при использовании устаревших API и библиотек), когда до сих пор требуется выполнение кода на выделенном потоке.</p><p>Возьмем следующий пример. Пусть у вас есть сетевой поток (networkThread) на котором открыт сокет для поддержания постоянного соединения с сервером, кроме того есть парсер для данных, поступающих по этому сокету. Тут налицо частая ошибка, когда сетевые программисты выносят операции ввода-вывода в другой поток, однако парсят данные на главном, тем самым интерфейс “заикается” в момент приема данных.</p><p>Вообще, данные, которые вы хотите послать через сеть, появляются когда что-то происходит в интерфейсе приложения (например, кто-то нажал кнопку), следовательно в главном потоке. Затем необходимо эти данные передать в сетевой поток, чтобы они могли быть отправлены по назначению.</p><p>Например, необходимо послать имя (firstName) и фамилию (lastName) человека и название компании (companyName) через сетевое соединение.</p><p>В идеале, неплохо бы иметь метод, вида:</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendFirstName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">firstName</span>
            <span class="nf">lastName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">lastName</span>
         <span class="nf">companyName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">companyName</span><span class="p">;</span>
</pre></table></code></div></div><p>Этот метод производил бы преобразование данных в формат, в котором они будут отсылаться через сеть (например, XML, JSON, …) и ставил бы в очередь сокета для отправки.</p><p>Проблема состоит в том, что если два потока попытаются использовать один и тот же сокет в один и тот же момент времени - приложение упадет. Поэтому этот метод может быть вызван только из сетевого потока (networkThread). Это, кстати, важно и для других API, которые не обеспечивают потокобезопасность.</p><p>Поэтому создадим еще один метод вида:</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onNetworkThreadSendFirstName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">firstName</span>
                           <span class="nf">lastName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">lastName</span>
                        <span class="nf">companyName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">companyName</span><span class="p">;</span>
</pre></table></code></div></div><p>и сохраним исходный для использования на главном потоке. Итак, как же вызвать метод на другом потоке? Это нельзя сделать напрямую, вместо этого нам надлежит использовать:</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">performSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">selector</span>
              <span class="nf">onThread</span><span class="p">:(</span><span class="n">NSThread</span> <span class="o">*</span><span class="p">)</span><span class="nv">thread</span>
            <span class="nf">withObject</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">object</span>
         <span class="nf">waitUntilDone</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">wait</span><span class="p">;</span>
</pre></table></code></div></div><p>Единственная проблема в том, что мы в данном методе может передать только один параметр (withObject), хотя в примере нам необходимо передать три.</p><p>Все что нам необходимо сделать, это поместить все три аргумента в один объект. Это можно попытаться сделать с помощью массива, с помощью специального объекта (из пушки по воробьям, так как этот объект будет использоваться только для передачи аргументов в метод) или с помощью словаря, чем мы и воспользуемся.</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onNetworkThreadSendArguments</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">arguments</span><span class="p">;</span>
</pre></table></code></div></div><p>Если следовать всему вышесказанному, то код будет выглядеть примерно следующим образом:</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendFirstName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">firstName</span> 
            <span class="nf">lastName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">lastName</span> 
         <span class="nf">companyName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">companyName</span>
<span class="p">{</span>
    <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nf">dictionaryWithObjectsAndKeys</span><span class="p">:</span>
        <span class="n">firstName</span><span class="p">,</span> <span class="s">@"firstName"</span><span class="p">,</span>
        <span class="n">lastName</span><span class="p">,</span> <span class="s">@"lastName"</span><span class="p">,</span>
        <span class="n">companyName</span><span class="p">,</span> <span class="s">@"companyName"</span><span class="p">,</span>
        <span class="nb">nil</span>
    <span class="p">];</span>
 
    <span class="p">[</span><span class="n">self</span> <span class="nf">performSelector</span><span class="p">:</span> <span class="k">@selector</span><span class="p">(</span><span class="nf">onNetworkThreadSendArguments</span><span class="p">:)</span> 
                 <span class="nl">onThread:</span> <span class="n">networkThread</span> 
               <span class="nl">withObject:</span> <span class="n">arguments</span> 
            <span class="nl">waitUntilDone:</span> <span class="nb">NO</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onNetworkThreadSendArguments</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">arguments</span>
<span class="p">{</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">firstName</span> <span class="o">=</span> <span class="p">[</span><span class="n">arguments</span> <span class="nf">objectForKey</span><span class="p">:</span> <span class="s">@"firstName"</span><span class="p">];</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">lastName</span> <span class="o">=</span> <span class="p">[</span><span class="n">arguments</span> <span class="nf">objectForKey</span><span class="p">:</span> <span class="s">@"lastName"</span><span class="p">];</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">companyName</span> <span class="o">=</span> <span class="p">[</span><span class="n">arguments</span> <span class="nf">objectForKey</span><span class="p">:</span> <span class="s">@"companyName"</span><span class="p">];</span>
 
    <span class="p">[</span><span class="n">self</span> <span class="nf">onNetworkThreadSendFirstName</span><span class="p">:</span> <span class="n">firstName</span>
                              <span class="nl">lastName:</span> <span class="n">lastName</span>
                           <span class="nl">companyName:</span> <span class="n">companyName</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">onNetworkThreadSendFirstName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">firstName</span> 
                            <span class="nf">lastName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">lastName</span> 
                         <span class="nf">companyName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">companyName</span>
<span class="p">{</span>
    <span class="c1">//format and send data</span>
<span class="p">}</span>
</pre></table></code></div></div><p>До Mac OS X 10.6 это было обычной практикой, но она требует много дополнительных методов, упаковку и распаковку аргументов для кросс-поточных вызовов. Но благодаря нашей категории, мы может решить задачу гораздо проще:</p><div class="language-objc highlighter-rouge"><div class="code-header"> <span data-label-text="Objective-C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Скопировано успешно!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendFirstName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">firstName</span>
            <span class="nf">lastName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">lastName</span>
         <span class="nf">companyName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">companyName</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">networkThread</span> <span class="nf">BOT_performBlock</span><span class="p">:</span> <span class="o">^</span><span class="p">{</span>
        <span class="c1">// format and send data</span>
    <span class="p">}];</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Так как блок кода всегда будет выполнен только на сетевом потоке, метод можно вызывать из любого потока. Видно, что блоки представляют собой крайне удобное средство, даже без использования Grand Central Dispatch.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/objectivec/'>ObjectiveC</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/objective-c/" class="post-tag no-text-decoration" >objective-c</a> <a href="/tags/nsthread/" class="post-tag no-text-decoration" >nsthread</a> <a href="/tags/blocks/" class="post-tag no-text-decoration" >blocks</a> <a href="/tags/%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%B8/" class="post-tag no-text-decoration" >потоки</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Публикация защищена лицензией <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> .</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Поделиться</span> <span class="share-icons"> <a href="https://t.me/share/url?url=http%3A%2F%2Fitw66.ru%2Fblog%2Fobj_c%2F590.html&text=%D0%92%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B1%D0%BB%D0%BE%D0%BA%D0%B0%20%D0%BA%D0%BE%D0%B4%D0%B0%20%D0%B2%20%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC%20%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%B5%0A%20-%20It%20Works!" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Скопировать ссылку" data-title-succeed="Ссылка успешно скопирована!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Недавно обновлено</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/china/2.html">Дух Китая. День второй </a><li class="text-truncate lh-lg"> <a href="/blog/china/4.html">Дух Китая. Пекин. Запретный город </a><li class="text-truncate lh-lg"> <a href="/blog/china/1.html">Дух Китая. Первый день, первые впечатления. </a><li class="text-truncate lh-lg"> <a href="/blog/12.html">5 инструментов работы с текстом которые вы обязаны знать </a><li class="text-truncate lh-lg"> <a href="/blog/c_plus_plus/14.html">Как избавится от vcredist'a </a></ul></div><div id="access-tags"><div class="panel-heading">Популярные теги</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D1%81/">космос</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F/">альтернативная энергия</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%81%D0%BE%D0%BB%D0%BD%D0%B5%D1%87%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F/">солнечная энергия</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F-%D0%B2%D0%B5%D1%82%D1%80%D0%B0/">энергия ветра</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%BA%D0%B8%D1%82%D0%B0%D0%B9/">китай</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B5%D1%82%D0%B8%D0%BA%D0%B0/">альтернативная энергетика</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B2%D0%BE%D0%B4%D0%B0/">вода</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%8D%D0%BA%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F/">экология</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B7%D0%B5%D0%BC%D0%BB%D1%8F/">земля</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Вам также может быть интересно</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/blog/sport_in_your_life/579.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1326909600" data-df="DD/MM/YYYY" > 19/01/2012 </em><h4 class="pt-0 my-2" data-toc-skip>Учитесь, пропуская мир через себя</h4><div class="text-muted small"><p> Очень хорошее ощущение, когда ты пропускаешь что-либо через себя. Начинается все с воздуха при вдохе, но не только… Занимаясь спортом, вы пропускаете через себя энергию тренировок. Чем лучше вы чув...</p></div></div></a></div><div class="col"> <a href="/blog/obj_c/585.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1327600800" data-df="DD/MM/YYYY" > 27/01/2012 </em><h4 class="pt-0 my-2" data-toc-skip>Полный список директив компилятора Objective-C 2.0</h4><div class="text-muted small"><p> Очень сложно найти полный список директив компилятора Objective-C в одном месте. Всем конечно известны @interface, @implementation, но есть и такие, как @dynamic и @encode которые встречают гораздо...</p></div></div></a></div><div class="col"> <a href="/blog/obj_c/586.html" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1327687200" data-df="DD/MM/YYYY" > 28/01/2012 </em><h4 class="pt-0 my-2" data-toc-skip>Singleton с помощью dispatch_once</h4><div class="text-muted small"><p> Вы можете любить его, можете ненавидеть, но иногда он очень нужен вам в вашем приложении. Фактически, любое приложение для iOS и Mac OS X имеют как минимум один - UIApplication или NSApplication....</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/technologies/589.html" class="btn btn-outline-primary" prompt="Следующая публикация" ><p>Графен обещает сверхбыстрые компьютеры !?</p></a> <a href="/blog/application_development/591.html" class="btn btn-outline-primary" prompt="Предыдущая публикация" ><p>Взаимозаменяемые сотрудники</p></a></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Популярные теги</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D1%81/">космос</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F/">альтернативная энергия</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%81%D0%BE%D0%BB%D0%BD%D0%B5%D1%87%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F/">солнечная энергия</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B8%D1%8F-%D0%B2%D0%B5%D1%82%D1%80%D0%B0/">энергия ветра</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%BA%D0%B8%D1%82%D0%B0%D0%B9/">китай</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%B0%D1%8F-%D1%8D%D0%BD%D0%B5%D1%80%D0%B3%D0%B5%D1%82%D0%B8%D0%BA%D0%B0/">альтернативная энергетика</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B2%D0%BE%D0%B4%D0%B0/">вода</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D1%8D%D0%BA%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F/">экология</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/%D0%B7%D0%B5%D0%BC%D0%BB%D1%8F/">земля</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme</p><p>© 2023 <a href=""></a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Публикации на сайте защищены лицензией Creative Commons Attribution 4.0 International (CC BY 4.0), если в тексте публикации не указано иное." >Некоторые права защищены.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">Доступна новая версия контента.</p><button type="button" class="btn btn-primary" aria-label="Update"> Обновлять </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/ru.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-16734363-3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-16734363-3'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript"></script><div style="display:none;"><script type="text/javascript"> try { var yaCounter1534027 = new Ya.Metrika(1534027); } catch(e){} </script></div><noscript><div style="position:absolute"><img src="//mc.yandex.ru/watch/1534027" alt="" /></div></noscript>
